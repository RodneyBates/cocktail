BIN	= $(INSTALLGMD)/bin
LIB	= $(INSTALLGMD)/lib

# VPATH = ../src

MAKEINCLUDE = ../../../make.include
MC	= mocka_mtc

REX = rex
LALR = lalr
CG = cg
PUMA = puma
RPP = rpp

# CGXZ     = cg.org
CGWFLAG  = -w 
CGXZ     = $(CG)

SED	= sed -e 's/!!$$/WriteNl (f);/' \
	      -e 's/!\([^!]*\)!$$/WriteS (f, "\1"); WriteNl (f);/' \
	      -e 's/!\([^!]*\)!/WriteS (f, "\1");/g' \
	      -e "s/@\([^@]*\)@$$/WriteS (f, '\1'); WriteNl (f);/" \
	      -e "s/@\([^@]*\)@/WriteS (f, '\1');/g"

MODULASOURCES = Assertions.md Assertions.mi \
                IOUtils.md IOUtils.mi \
                puma.mi

OTHERSOURCES = 

SOURCES = $(MODULESOURCES) $(OTHERSOURCES) 

MODULAGENS	= Scanner.mi Scanner.md Parser.md Parser.mi Tree.md Tree.mi \
          Tree2.md Tree2.mi Semantics.md Semantics.mi Optimize.md \
          Optimize.mi M2.md M2.mi M3.md M3.mi Ada.md Ada.mi C.md C.mi 

OTHERGENS = Scanner.Tab Parser.Tab

GENS    = $(MODULAGENS) $(OTHERGENS)
EXE     = puma

MOCKAFLAGS = 
MOCKALIBS = -d ../src -d ../../../reuse/src

include $(MAKEINCLUDE)

# source code generations: 

Scanner.rpp Parser.lalr:	../src/puma.pars
	$(CGXZ) -xzj ../src/puma.pars;

puma.rex:	../src/puma.scan Scanner.rpp
	$(RPP) < ../src/puma.scan > puma.rex;

Scanner.md Scanner.mi Scanner.Tab:	puma.rex
	$(REX) -d puma.rex;

Parser.md:	Parser.lalr
	$(LALR) -d Parser.lalr;

Parser.mi Parser.Tab:	Parser.lalr
	$(LALR) -v Parser.lalr;

Tree.md:	../src/puma.cg
	echo 'Be sure cg is also rebuilt with this new version of puma.cg.' 
	echo SELECT AstIn Ast Common PumaIn Puma | cat - ../src/puma.cg | \
	$(CG) $(CGWFLAG) -dimRyq

Tree.mi:	../src/puma.cg
	echo SELECT AstIn Ast Common PumaIn Puma | cat - ../src/puma.cg | \
	$(CG) $(CGWFLAG) -imRyq

Tree2.md:	../src/puma.cg
	echo SUBUNIT Tree2 SELECT AstIn Ast | cat - ../src/puma.cg | $(CG) -dig

Tree2.mi:	../src/puma.cg
	echo SUBUNIT Tree2 SELECT AstIn Ast | cat - ../src/puma.cg | $(CG) -ig

Tree.TS:	../src/puma.cg
	echo SELECT PumaIn Puma | cat - ../src/puma.cg | $(CG) -4

Semantics.md Semantics.mi:	../src/sem.puma Tree.TS
	$(PUMA) -dinwuX ../src/sem.puma;

Optimize.md Optimize.mi:	../src/opt.puma Tree.TS
	$(PUMA) -diwkuX ../src/opt.puma;

M2.md M2.mi:	../src/M2.puma Tree.TS
	$(SED) < ../src/M2.puma | $(PUMA) -dinwuX;

M3.md M3.mi:	../src/M3.puma Tree.TS
	$(SED) < ../src/M3.puma | $(PUMA) -dinwuX;

Ada.md Ada.mi:	../src/ada.puma Tree.TS
	$(SED) < ../src/ada.puma | $(PUMA) -dinwuX;

C.md C.mi:	../src/c.puma Tree.TS
	$(SED) < ../src/c.puma | $(PUMA) -dinwuX;

# swap all byte pairs of the files Scanner.Tab and Parser.Tab

bin.conv:
	dd conv=swab < Scanner.Tab > .Scanner.Tab; mv .Scanner.Tab Scanner.Tab
	dd conv=swab < Parser.Tab > .Parser.Tab; mv .Parser.Tab Parser.Tab

#install_modula:	puma puma.sh $(LIB)/puma Scanner.Tab Parser.Tab TypeTab.c TypeTab.a TypeTab.m TypeTab.m3
#	if test $(LIB) = $(BIN); then echo error: BIN = LIB; false; else true; fi
#	sed 's;LIB;$(LIB);g' < puma.sh > $(BIN)/puma
#	chmod a+rx $(BIN)/puma
##	install -c -s -m 755 puma $(LIB)/puma
#	install -c    -m 755 puma $(LIB)/puma
#	install -c -m 644 Scanner.Tab $(LIB)/puma
#	install -c -m 644 Parser.Tab $(LIB)/puma
#	install -c -m 644 TypeTab.c $(LIB)/puma
#	install -c -m 644 TypeTab.a $(LIB)/puma
#	install -c -m 644 TypeTab.m $(LIB)/puma
#	install -c -m 644 TypeTab.m3 $(LIB)/puma

#install_org:
#	cd ../../rebuild/puma/mtc; make install

# installation directories

#$(LIB)/puma:	$(LIB)
#	sh -c "if test ! -d $(LIB)/puma; then mkdir $(LIB)/puma; else true; fi"

# support for mkid (undoubtedly needs work as of 4-1999) 

pumaId:	puma.rex
	echo SCANNER pumaId | cat - puma.rex | \
	sed 's/\(RETURN 1	\)/yyEcho; IO.WriteNl (IO.StdOutput); \1/' | \
	$(BIN).t/rex -sd;
	sed 's/@/pumaId/' < ../../../front/src/Id.mi > pumaIdDrv.mi
	echo p pumaIdDrv | mc -d ../../../reuse/src
	mv pumaIdDrv pumaId

installId:	pumaId $(LIB)/Id
	echo exec $(LIB)/Id/pumaId -l$(LIB)/Id "2> /dev/null" > $(BIN)/pumaId
	chmod a+rx $(BIN)/pumaId
	install -c -m 644 pumaId.Tab $(LIB)/Id
	install -c -s -m 755 pumaId $(LIB)/Id

$(LIB)/Id:	$(LIB)
	sh -c "if test ! -d $(LIB)/Id; then mkdir $(LIB)/Id; else true; fi"

cleanId:
	rm -f pumaId*

clean:	cleanId
	rm -f _Debug core $(GENS) *.[dior] 


